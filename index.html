<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Calculadora de Cuotas del Club</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Roboto', Arial, sans-serif; background:#f5f7fb; color:#111; padding:20px; }
.card { background:#fff; border-radius:10px; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.06); width:95%; max-width:1000px; margin:0 auto; }
h1{margin:0 0 14px}
.row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px; }
label { font-weight:600; font-size:.95rem; margin-bottom:6px; display:block; }
select, .output { padding:8px 10px; border-radius:8px; border:1px solid #d0d7e0; font-size:1rem; }
.member { border:1px dashed #e0e6ef; padding:10px; border-radius:8px; margin-bottom:5px; background:#fbfdff; transition: background 0.3s; }
.member h3 { margin:0 0 8px; font-size:1rem; }
.member.free { background:#fff3e0; }
.results { margin-top:12px; padding:10px; border-radius:8px; background:#f0f6ff; font-weight:700; width: 100%; box-sizing: border-box; }
.small { font-size:.9rem; color:#555; }
.inline { display:flex; gap:10px; align-items:center; }
.total { margin-top:12px; padding:12px; border-radius:8px; background:#e8f6ea; font-weight:800; font-size:1.05rem; width: 100%; box-sizing: border-box; }
button { padding:8px 12px; border-radius:8px; border:0; background:#387b5b; color:#fff; cursor:pointer; }
button:disabled { background:#d5e4d9; cursor:not-allowed; }
.member .altaCuota { margin-top:4px; font-weight:600; color:#1f6feb; font-size:0.85rem; }
.member .plazosCuota { margin-top:2px; color:#555; font-size:.85rem; }
.total-claro { display:block; font-size:0.9em; color:#333; background-color:#f8f9fa; border:1px solid #ddd; padding:6px 10px; margin-top:10px; border-radius:6px; line-height:1.4em; text-align:right; width:fit-content; margin-left:auto; }
.total-claro span.small { font-size:0.8em; color:#007bff; text-decoration:underline; cursor:pointer; }
.popupLink { color:#007bff; text-decoration:underline; cursor:pointer; }
.resumenLine { font-size:0.85em; margin-bottom:2px; }
.popupOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.popupBox {
  background: #fff;
  border-radius: 10px;
  max-width: 420px;
  padding: 20px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.25);
  text-align: left;
  font-size: 0.9rem;
}
.popupBox h3 {
  margin-top: 0;
  font-size: 1.1rem;
  color: #387b5b;
}
.popupClose {
  float: right;
  font-weight: bold;
  cursor: pointer;
  color: #387b5b;
}
.popupClose:hover {
  color: #333;
}

</style>
</head>
<body>
<div class="card">
        <h1>Calculadora de cuotas del club</h1>
            <div id="infoContext" style="margin-bottom: 20px; padding: 15px; background: #fdf3f3; border: 1px solid #f9dcdc; border-radius: 8px; font-size: 0.95rem; line-height: 1.5;">
            <p style="margin-top: 0; font-weight: bold; color: #b03a3a;">
                Cuota anual aprobada en Asamblea General del 22 de febrero de 2025
            </p>
            <p>
                La CUOTA ANUAL se domicilia en 6 plazos, para hacer mÃ¡s asequible su pago.
            </p>
            <p style="color: #b03a3a; font-weight: 500;">
                âš ï¸ NO SON COBROS QUE CORRESPONDAN A MESES, DÃAS u HORAS DE ACTIVIDAD; SINO UNA APORTACIÃ“N ANUAL PARA EL SUSTENTO DEL CLUB PARA TODO EL AÃ‘O, independientemente de la duraciÃ³n del periodo y sesiÃ³n de los entrenamientos.
            </p>
            <p>
                âš ï¸ SegÃºn la categorÃ­a y la secciÃ³n, el plazo y la duraciÃ³n de entrenamiento suele variar.
            </p>
            <p>
                â„¹ï¸ A partir del 1 de octubre de 2025 (1 de noviembre de 2025 para el grupo Master), segÃºn aprobaciÃ³n en Asamblea General del 28 de enero de 2023, las nuevas inscripciones tendrÃ¡n que abonar cuota de alta de 28â‚¬.
            </p>
            <p style="margin-bottom: 0;">
                Junto con la inscripciÃ³n, la persona inscrita o en su caso un tutor legal, se hace socio/a del club, lo que le da derecho a participar y a votar en el seno de la Asamblea General, entre otras cosas. Puedes ver aquÃ­ los  
                <a href="https://www.es.buruntzaldeaikt.eus/assets/files/BIKT-ESTATUTUAK-CAS.pdf" target="_blank">Estatutos del Club</a>
            </p>
        </div>
        <div class="row">
<div class="row">
  <div style="width:250px">
    <label>
  <input type="checkbox" id="useRGI" name="rgiCheck" class="rgiCheck">
  Aplicar descuento RGI / IMV 
  <span class="small" title="Ayuda RGI / IMV, descuento del 75%. Si seleccionas este descuento, tendrÃ¡s que presentar justificante de haber cobrado la ayuda antes del 25 de cada mes.<br>Al seleccionar Ayuda RGI / IMV, descuento del 75% no se aplican los descuentos por familiares.">(?)</span>
</label>
  </div>
  <div style="width:200px">
    <label for="totalFam">Total familiares</label>
    <select id="totalFam">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4 o mÃ¡s</option>
    </select>
  </div>
  <div style="width:160px; align-self:flex-end">
    <button id="loadBtn">Pulsa para cargar datos y empezar</button>
  </div>
</div>

<div id="membersContainer"></div>

<div id="summaryArea" style="display:none; width: 100%;">
Â  <div class="results"><strong>Resumen</strong><br></div>
Â  <div class="results" id="resultsBox"></div>
Â  <div class="total" id="totalBox">Total: â€”</div>
</div>
</div>

<script>
// --------------------- CONFIGURACIÃ“N DE CSV ---------------------
const csvSheets = {
"2019 1 dÃ­a Lasarte-Oria":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=1104631462&single=true&output=csv",
"2019 2 dÃ­as Lasarte-Oria":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=594372538&single=true&output=csv",
"2018-2014 Lasarte-Oria":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=854262720&single=true&output=csv",
"2013-2012 Lasarte-Oria":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=174360607&single=true&output=csv",
"2011--> 18+ Lasarte-Oria":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=786890196&single=true&output=csv",
"2017--> 18+ Andoain":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=641105268&single=true&output=csv",
"Nat. ParticipaciÃ³n 1 dÃ­a":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=541455715&single=true&output=csv",
"Nat. ParticipaciÃ³n 2 dÃ­as":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=2101736621&single=true&output=csv",
"Master":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=2128438898&single=true&output=csv"
};

let sheets = {};
const loadBtn = document.getElementById('loadBtn');
const membersContainer = document.getElementById('membersContainer');
const totalFamSelect = document.getElementById('totalFam');
const summaryArea = document.getElementById('summaryArea');
const resultsBox = document.getElementById('resultsBox');
const totalBox = document.getElementById('totalBox');
const useRGIcheckbox = document.getElementById('useRGI');

// --------------------- CARGA DE CSV ---------------------
loadBtn.addEventListener('click', async()=>{
  loadBtn.disabled=true; loadBtn.textContent='Cargando...';
  membersContainer.innerHTML=''; summaryArea.style.display='none'; sheets={};
  try{
    await Promise.all(Object.entries(csvSheets).map(async([name,url])=>{
      const r = await fetch(url); if(!r.ok) throw new Error('Error al cargar '+name);
      const text = await r.text();
      sheets[name] = csvToObjects(text);
    }));
    createMemberBlocks();
    summaryArea.style.display='block';
    recalcAll();
  }catch(e){ alert('Error cargando CSV: '+e.message);}
  finally{loadBtn.disabled=false; loadBtn.textContent='Datos cargados';}
});

totalFamSelect.addEventListener('change',()=>{
  createMemberBlocks();
  recalcAll();
});
useRGIcheckbox.addEventListener('change', recalcAll);

// --------------------- CREACIÃ“N DE BLOQUES ---------------------
function createMemberBlocks(){
Â  membersContainer.innerHTML='';Â 
Â  const count=Number(totalFamSelect.value);
Â  for(let i=0;i<count;i++){
Â  Â  const div=document.createElement('div'); div.className='member';
Â  Â  // Usamos flexbox para que los tres divs internos compartan el espacio disponible
Â  Â  div.innerHTML=`<h3>Familiar ${i+1}</h3>
Â  Â  <div style="display: flex; gap: 5px; flex-wrap: wrap;">Â 
Â  Â  Â Â 
Â  Â  Â  <div style="flex: 1; min-width: 280px; align-self: flex-start;">Â 
Â  Â  Â  Â  <label>Selecciona Grupo</label>
Â  Â  Â  Â  <select class="sheetSelect"></select>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <div style="flex: 1; min-width: 200px; align-self: flex-start;">Â 
Â  Â  Â  Â  <label>Mes de inicio</label>
Â  Â  Â  Â  <select class="monthSelect"><option>â€”</option></select>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â <div style="flex: 1; min-width: 250px; align-self: flex-start;">
Â  Â  Â  Â  
    <label>Cuota aplicada</label>
Â  Â  Â  Â  <div style="display: flex; gap: 8px; align-items: center; justify-content: space-between; flex-wrap: wrap;"> 
Â  Â  Â  Â  Â  <div class="output feeDisplay" style="flex: 1;">â€”</div> 
Â  Â  Â  Â  Â  <div class="altaCuota" style="white-space: nowrap;"></div> 
Â  Â  Â  Â  Â  <div class="plazosCuota small" style="white-space: nowrap;"></div> 
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
    <div class="explicacionCuota"></div>
    `;
Â  Â  membersContainer.appendChild(div);
Â  Â  const sheetSel = div.querySelector('.sheetSelect');
Â  Â  Object.keys(csvSheets).forEach(name=>{
Â  Â  Â  const opt=document.createElement('option'); opt.value=name; opt.textContent=name; sheetSel.appendChild(opt);
Â  Â  });
Â  Â  sheetSel.addEventListener('change', ()=>{
Â  Â  Â  populateMonthsForMember(div);
Â  Â  Â  recalcAll();
Â  Â  });
Â  Â  div.querySelector('.monthSelect').addEventListener('change', recalcAll);
Â  }
Â  document.querySelectorAll('.member').forEach(m=>{
Â  Â  const s=m.querySelector('.sheetSelect');
Â  Â  if(s.options.length)s.selectedIndex=0;
Â  Â  populateMonthsForMember(m);
Â  });
}

// --------------------- POBLAR MESES ---------------------
function populateMonthsForMember(memberDiv){
  const sheetSel = memberDiv.querySelector('.sheetSelect');
  const monthSel = memberDiv.querySelector('.monthSelect');
  monthSel.innerHTML = '';
  const sheet = sheets[sheetSel.value];
  if(!sheet){ 
    monthSel.innerHTML='<option>â€”</option>'; 
    return;
  }
  const months = sheet.map(r => r['Mes inicio']).filter(Boolean);
  const seen = new Set();
  const uniq = months.filter(m => (seen.has(m)?false:seen.add(m)));
  if(uniq.length === 0){
      monthSel.innerHTML='<option>â€”</option>';
  } else {
      uniq.forEach(m=>{
          const o = document.createElement('option');
          o.value = m;
          o.textContent = m;
          monthSel.appendChild(o);
      });
      monthSel.selectedIndex = 0;
  }
}

// --------------------- PARSE CSV ---------------------
function csvToObjects(csv){
Â  const rows=[]; const lines=csv.split(/\r\n|\n/);Â 
Â  if(lines.length<9) return rows;
Â  const headers=parseCsvLine(lines[7]); // <-- Volvemos a usar la LÃ­nea 7
Â  for(let i=8;i<lines.length;i++){Â  // <-- Volvemos a empezar la lectura en la LÃ­nea 8
Â  Â  if(!lines[i].trim()) continue;
Â  Â  const vals=parseCsvLine(lines[i]);Â 
Â  Â  const obj={};
Â  Â  for(let j=0;j<headers.length;j++) obj[headers[j].trim()]=vals[j]?vals[j].trim():'';Â 
Â  Â  rows.push(obj);
Â  }Â 
Â  return rows;
}
function parseCsvLine(line){
  const result=[]; let inQuotes=false, val=''; 
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='\"') inQuotes=!inQuotes;
    else if(ch===',' && !inQuotes){ result.push(val); val=''; }
    else val+=ch;
  }
  result.push(val); return result;
}

// --------------------- CÃLCULO DE CUOTAS ---------------------
function recalcAll(){
  const members = document.querySelectorAll('.member');
  const countFam = Number(totalFamSelect.value);
  const useRGI = useRGIcheckbox.checked;
  const fees = [];

  members.forEach((m)=>{
    const sheetName = m.querySelector('.sheetSelect').value;
    const month = m.querySelector('.monthSelect').value;
    const sheet = sheets[sheetName];
    let fee = 0;
    let row = null;

    if(sheet && month && month !== 'â€”'){
      row = sheet.find(r => r['Mes inicio']?.trim() === month.trim());
     if(row){
Â  Â  Â  Â  // 1. Obtenemos la cuota base de '1 familiar' (o el encabezado de la cuota completa)
Â  Â  Â  Â  fee = parseFloat((row['1 familiar']||'0').replace(',','.').replace('â‚¬','')) || 0;
Â  Â  Â  Â  
Â  Â  Â  Â  // 2. Si se usa RGI, aplicamos el descuento del 75% (pagar el 25%)
Â  Â  Â  Â  if (useRGI && fee > 0) {
Â  Â  Â  Â  Â  fee = fee * 0.25; 
Â  Â  Â  Â  }
Â  Â  Â  }
    }

    fees.push({div:m, fee, row});
    m.classList.remove('free');
  });

  // Ajuste por nÃºmero de familiares si NO RGI
  if(!useRGI){
    if(countFam === 2){
      fees.forEach(f => {
        if(f.row) f.fee = parseFloat((f.row['2 familiares']||f.fee).replace(',','.').replace('â‚¬','')) || f.fee;
      });
    } else if(countFam === 3){
      const sorted = [...fees].sort((a,b)=>b.fee - a.fee);
      if(sorted[0] && sorted[0].row) sorted[0].fee = parseFloat((sorted[0].row['2 familiares']||sorted[0].fee).replace(',','.').replace('â‚¬','')) || sorted[0].fee;
      if(sorted[1] && sorted[1].row) sorted[1].fee = parseFloat((sorted[1].row['2 familiares']||sorted[1].fee).replace(',','.').replace('â‚¬','')) || sorted[1].fee;
      if(sorted[2] && sorted[2].row) sorted[2].fee = parseFloat((sorted[2].row['Tercer familiar']||sorted[2].fee).replace(',','.').replace('â‚¬','')) || sorted[2].fee;
    } else if(countFam >= 4){
      const sorted = [...fees].sort((a,b)=>b.fee - a.fee);
      if(sorted[0] && sorted[0].row) sorted[0].fee = parseFloat((sorted[0].row['2 familiares']||sorted[0].fee).replace(',','.').replace('â‚¬','')) || sorted[0].fee;
      if(sorted[1] && sorted[1].row) sorted[1].fee = parseFloat((sorted[1].row['2 familiares']||sorted[1].fee).replace(',','.').replace('â‚¬','')) || sorted[1].fee;
      if(sorted[2] && sorted[2].row) sorted[2].fee = parseFloat((sorted[2].row['Tercer familiar']||sorted[2].fee).replace(',','.').replace('â‚¬','')) || sorted[2].fee;
      for(let i=3;i<sorted.length;i++) sorted[i].fee = 0;
    }
  }

  // Cuota de alta
  fees.forEach(f=>{
    const monthSel = f.div.querySelector('.monthSelect');
    const altaDiv = f.div.querySelector('.altaCuota');
    const monthIndex = monthSel.selectedIndex;
    const alta = (monthIndex >= 1) ? 28 : 0;
    f.alta = alta;
    altaDiv.innerHTML = alta ? '<span style="color:#387b5b;">Cuota de Alta: 28 â‚¬ (Solamente una vez)</span>' : '';
  });

  // Mostrar cuota
  fees.forEach(f=>{
    const display = f.div.querySelector('.feeDisplay');
    display.textContent = f.fee > 0 ? f.fee.toFixed(2)+' â‚¬' : '0 â‚¬ (no paga)';
  });

 // Plazos
Â  fees.forEach(f=>{
Â  Â  const monthSel = f.div.querySelector('.monthSelect');
Â  Â  const sheetName = f.div.querySelector('.sheetSelect').value; // Necesitamos el grupo para saber si es Master
Â  Â  const monthIndex = monthSel.selectedIndex;
Â  Â  const isMaster = sheetName.includes('Master');
// ... (cÃ³digo anterior)

Â  Â  // Elemento donde mostraremos el texto condicional
Â  Â  const explainerDiv = f.div.querySelector('.explicacionCuota'); 
Â  Â  let explainerText = '';

Â  Â  // --------------------- LÃ³gica de ExplicaciÃ³n Condicional ---------------------
Â  Â  // Si el mes de inicio es el segundo o posterior (Ã­ndice 1 o mayor):
Â  Â  if (monthIndex >= 1) {
Â  Â  Â  // Definir los meses lÃ­mite para la explicaciÃ³n
Â  Â  Â  const ultimoPlazo = isMaster ? 'abril' : 'marzo';
Â  Â  Â  const inicioAlta = isMaster ? '1 de noviembre de 2025' : '1 de octubre de 2025';
Â  Â  Â  
Â  Â  Â  explainerText = `
Â  Â  Â  Â  <p style="font-size: 0.85rem; color: #1e8449; margin-top: 5px; padding: 5px; border-left: 3px solid #1e8449; background-color: #f0fff0;">
Â  Â  Â  Â  Â  **Ajuste de Cuota y Plazos:** Si alguien no comienza la temporada al principio, la cuota anual se adapta para que, junto con todos los demÃ¡s, el Ãºltimo plazo sea en marzo (abril para el grupo Master). Se tienen en cuenta los meses que no se han realizado.
Â  Â  Â  Â  Â  <br>
Â  Â  Â  Â  Â  **Cuota de Alta:** Quienes comienzan a partir del 1 de octubre (1 de noviembre para el grupo Master) tienen una cuota de alta de 28 â‚¬. Quienes se inscriben antes de esa fecha NO pagan cuota de alta.
Â  Â  Â  Â  </p>
Â  Â  Â  `;
Â  Â  }

Â  Â  explainerDiv.innerHTML = explainerText;
Â  Â  // --------------------- Fin LÃ³gica de ExplicaciÃ³n ---------------------

Â  // ... (el resto del cÃ³digo de plazos, fees.push, etc.)
Â  Â  let plazoText = '';
Â  Â  let infoPopupText = ''; // Variable para el contenido del popup

Â  Â  if(monthIndex === 0) {
Â  Â  Â  plazoText = '6 plazos domiciliaciÃ³n';
Â  Â  Â  infoPopupText = isMaster 
Â  Â  Â  Â  ? 'Del 1 al 5 de {Noviembre, Diciembre, Enero, Febrero, Marzo y Abril}'
Â  Â  Â  Â  : 'Del 1 al 5 de {Octubre, Noviembre, Diciembre, Enero, Febrero y Marzo}';
Â  Â  } else if(monthIndex === 1) {
Â  Â  Â  plazoText = '5 plazos domiciliaciÃ³n';
Â  Â  Â  infoPopupText = isMaster
Â  Â  Â  Â  ? 'Del 1 al 5 de {Diciembre, Enero, Febrero, Marzo y Abril}'
Â  Â  Â  Â  : 'Del 1 al 5 de {Noviembre, Diciembre, Enero, Febrero y Marzo}';
Â  Â  } else if(monthIndex === 2) {
Â  Â  Â  plazoText = '4 plazos domiciliaciÃ³n';
Â  Â  Â  infoPopupText = isMaster
Â  Â  Â  Â  ? 'Del 1 al 5 de {Enero, Febrero, Marzo y Abril}'
Â  Â  Â  Â  : 'Del 1 al 5 de {Diciembre, Enero, Febrero y Marzo}';
Â  Â  } else if(monthIndex === 3) {
Â  Â  Â  plazoText = '3 plazos domiciliaciÃ³n';
Â  Â  Â  infoPopupText = isMaster
Â  Â  Â  Â  ? 'Del 1 al 5 de {Febrero, Marzo y Abril}'
Â  Â  Â  Â  : 'Del 1 al 5 de {Enero, Febrero y Marzo}';
Â  Â  } else if(monthIndex === 4) {
Â  Â  Â  plazoText = '2 plazos domiciliaciÃ³n';
Â  Â  Â  infoPopupText = isMaster
Â  Â  Â  Â  ? 'Del 1 al 5 de {Marzo y Abril}'
Â  Â  Â  Â  : 'Del 1 al 5 de {Febrero y Marzo}';
Â  Â  } else if(monthIndex === 5) {
Â  Â  Â  plazoText = '1 plazo domiciliaciÃ³n';
Â  Â  Â  infoPopupText = isMaster
Â  Â  Â  Â  ? 'Del 1 al 5 de {Abril}'
Â  Â  Â  Â  : 'Del 1 al 5 de {Marzo}';
Â  Â  } else {
Â  Â  Â  plazoText = '1 pago por transferencia ABANCA ES75...'; // Usamos el texto de la cuota original
Â  Â  Â  infoPopupText = 'En el momento de la inscripciÃ³n';
Â  Â  Â  
Â  Â  Â  // Corregimos el texto de plazos para meses posteriores al sexto
Â  Â  Â  const mesesTransferencia = monthIndex - 5; 
Â  Â  Â  plazoText = `1 pago por transferencia (${mesesTransferencia}Âº mes desde el inicio de temporada)`;
Â  Â  }
Â  Â  
Â  Â  // Generamos el enlace al popup para mostrar los detalles del cobro
Â  Â  const infoLink = `<span class="popupLink" data-info="ğŸ“… <b>Fechas de DomiciliaciÃ³n:</b><br>${infoPopupText}"><small>[info]</small></span>`;

Â  Â  f.div.querySelector('.plazosCuota').innerHTML = `${plazoText} ${infoLink}`;
Â  });

// Total
Â  const totalMensual = fees.reduce((acc,f)=>acc + f.fee, 0); // Suma solo las cuotas mensuales (fee)
Â  const totalAlta = fees.reduce((acc,f)=>acc + f.alta, 0); // Suma solo las cuotas de alta (alta: 28â‚¬ o 0â‚¬)
Â  const totalPrimerPago = totalMensual + totalAlta; // Primer pago = Cuota Mensual + Cuota de Alta
Â  const totalGeneral = totalMensual + totalAlta; // El total general sigue siendo la suma de todo

Â  // Generamos el texto del detalle del primer pago condicionalmente
Â  const primerPagoDetail = (totalAlta > 0) 
Â  Â  ? `(Cuota club + Cuota de Alta)` 
Â  Â  : `(Cuota club)`;

Â  // Ajustamos el padding y margin-top para reducir el espacio vertical
Â  totalBox.innerHTML = `
Â  Â  <div>Total General: ${totalGeneral.toFixed(2)} â‚¬ (Incluye todas las cuotas de alta)</div>
Â  Â  
Â  Â  <div style="margin-top: 4px; padding: 2px 0; border-top: 1px solid #c0d0c0; line-height: 1.2;">
Â  Â  Â  **Primer Pago:** ${totalPrimerPago.toFixed(2)} â‚¬
Â  Â  Â  <span class="small" style="display: block; font-weight: normal; margin-top: 1px;">${primerPagoDetail}</span>
Â  Â  </div>
Â  Â Â 
Â  Â  <div style="padding: 2px 0; line-height: 1.2;">
Â  Â  Â  **Pagos Posteriores:** ${totalMensual.toFixed(2)} â‚¬
Â  Â  Â  <span class="small" style="display: block; font-weight: normal; margin-top: 1px;">(Cuota mensual por ${fees.length} familiares, sin cuota de alta)</span>
Â  Â  </div>
Â  `;

 // --------------------- RESUMEN ---------------------
resultsBox.innerHTML = ''; // limpiar contenido previo
fees.forEach((f, idx) => {
  const sheetName = f.div.querySelector('.sheetSelect').value;
  const month = f.div.querySelector('.monthSelect').value;

  let cuotaText = f.fee > 0 ? f.fee.toFixed(2)+' â‚¬' : '0 â‚¬ (no paga)';
  let altaText = f.alta ? ' + Cuota de Alta: 28 â‚¬ (Solamente una vez)' : '';

  let monthIndex = f.div.querySelector('.monthSelect').selectedIndex;
  let plazos = 1;
  let formaPago = '';

  if (monthIndex >= 0 && monthIndex <= 5) {
    plazos = 6 - monthIndex;
    formaPago = `<span class="popupLink" data-info='ğŸ¦â†ªï¸ <b>Cobro domiciliado:</b><br>Se realiza mediante domiciliaciÃ³n bancaria mensual.<br>El Ãºltimo plazo es del <b>1 al 5 de marzo</b> a excepciÃ³n del grupo "<b>Masters</b>", cuyo Ãºltimo plazo es del <b>1 al 5 de abril</b><br><br><br>
<b>Plazos de domiciliaciÃ³n:</b><br>
Durante la temporada 2025/2026, los plazos quedarÃ¡n de la siguiente manera:<br>
1Âª domiciliaciÃ³n: del 1 al 5 de octubre. <b>(Masters NO)</b><br>
2Âª domiciliaciÃ³n: del 1 al 5 de noviembre.(1Âª Masters)<br>
3Âª domiciliaciÃ³n: del 1 al 5 de diciembre.(2Âª Masters)<br>
4Âª domiciliaciÃ³n: del 1 al 5 de enero.(3Âª Masters)<br>
5Âª domiciliaciÃ³n: del 1 al 5 de febrero.(4Âª Masters)<br>
6Âª domiciliaciÃ³n: del 1 al 5 de marzo.(5Âª Masters)<br>
7Âª domiciliaciÃ³n: del 1 al 5 de marzo.(<b>SOLO Masters, 6Âª</b>).'>Cobro domiciliado</span>`;
  } else {
    formaPago = `<span class="popupLink" data-info='ğŸ¦â¡ï¸ <b>Transferencia bancaria:</b><br>La persona que se inscribe realiza un Ãºnico pago a la cuenta ABANCA proporcionada:<br><b>ABANCA ES75 2080 3637 8130 4003 7051</b>.'>Transferencia bancaria ABANCA ES75 2080 3637 8130 4003 7051</span>`;
  }

  const div = document.createElement('div');
  div.className = 'resumenLine';
  div.innerHTML = `Familiar ${idx+1}: ${sheetName} | ${month} | ${cuotaText}${altaText} | Plazos: ${plazos} (${formaPago})`;
  resultsBox.appendChild(div);
});

// --------------------- POPUPS MODERNOS ---------------------
document.querySelectorAll('.popupLink').forEach(el=>{
  el.addEventListener('click', e=>{
    e.preventDefault();

    const infoText = el.dataset.info;
    // Crear fondo oscuro
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.zIndex = '9999';
    overlay.style.padding = '10px';

    // Crear ventana del popup
    const popup = document.createElement('div');
    popup.style.background = '#fff';
    popup.style.fontFamily = "'Roboto', Arial, sans-serif";
    popup.style.padding = '22px 26px';
    popup.style.borderRadius = '12px';
    popup.style.boxShadow = '0 6px 20px rgba(0,0,0,0.25)';
    popup.style.maxWidth = '420px';
    popup.style.textAlign = 'left';
    popup.style.fontSize = '0.95rem';
    popup.style.lineHeight = '1.5em';
    popup.style.color = '#333';
    popup.innerHTML = `
      <h3 style="margin-top:0; color:#387b5b; font-size:1.1rem;">InformaciÃ³n</h3>
      <p style="margin-bottom:0.8em;">${infoText}</p>
      <div style="text-align:right; margin-top:12px;">
        <button id="closePopup" style="padding:6px 14px; border:none; border-radius:6px; background:#387b5b; color:white; cursor:pointer;">Cerrar</button>
      </div>
    `;

    overlay.appendChild(popup);
    document.body.appendChild(overlay);

    document.getElementById('closePopup').addEventListener('click', ()=>{
      overlay.remove();
    });
    overlay.addEventListener('click', e=>{
      if(e.target === overlay) overlay.remove();
    });
  });
});
// --------------------- POPUP RGI / IMV AL MARCAR CHECKBOX ---------------------
const rgiCheckbox = document.getElementById('rgiCheck');
if (rgiCheckbox) {
  rgiCheckbox.addEventListener('change', () => {
    if (rgiCheckbox.checked) {
      const infoText = `
      ğŸ’¶ <b>Ayuda RGI / IMV</b><br><br>
      Descuento del <b>75%</b> en la cuota.<br>
      Si seleccionas este descuento, deberÃ¡s presentar justificante de haber cobrado la ayuda <b>antes del dÃ­a 25 de cada mes</b><br>Al seleccionar Ayuda RGI / IMV, descuento del 75% no se aplican los descuentos por familiares.
      `;

      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '9999';
      overlay.style.padding = '10px';

      const popup = document.createElement('div');
      popup.style.background = '#fff';
      popup.style.fontFamily = "'Roboto', Arial, sans-serif";
      popup.style.padding = '22px 26px';
      popup.style.borderRadius = '12px';
      popup.style.boxShadow = '0 6px 20px rgba(0,0,0,0.25)';
      popup.style.maxWidth = '420px';
      popup.style.textAlign = 'left';
      popup.style.fontSize = '0.95rem';
      popup.style.lineHeight = '1.5em';
      popup.style.color = '#333';
      popup.innerHTML = `
        <h3 style="margin-top:0; color:#387b5b; font-size:1.1rem;">InformaciÃ³n descuento RGI / IMV</h3>
        <p style="margin-bottom:0.8em;">${infoText}</p>
        <div style="text-align:right; margin-top:12px;">
          <button id="closePopup" style="padding:6px 14px; border:none; border-radius:6px; background:#387b5b; color:white; cursor:pointer;">Cerrar</button>
        </div>
      `;

      overlay.appendChild(popup);
      document.body.appendChild(overlay);

      document.getElementById('closeRgiPopup').addEventListener('click', () => {
        overlay.remove();
      });
      overlay.addEventListener('click', e => {
        if (e.target === overlay) overlay.remove();
      });
    }
  });
}
}
// --------------------- POPUP RGI / IMV AL MARCAR CHECKBOX ---------------------
const rgiCheckbox = document.querySelector('#useRGI');
if (rgiCheckbox) {
  rgiCheckbox.addEventListener('change', () => {
    if (rgiCheckbox.checked) {
      const infoText = `
      â„¹ï¸ <b>Ayuda RGI / IMV</b><br><br>
      Descuento del <b>75%</b> en la cuota.<br>
      Si seleccionas este descuento, deberÃ¡s presentar justificante de haber cobrado la ayuda <b>antes del dÃ­a 25 de cada mes</b><br><br>Al seleccionar Ayuda RGI / IMV, descuento del 75% no se aplican los descuentos por familiares.
      `;

      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '9999';
      overlay.style.padding = '10px';

      const popup = document.createElement('div');
      popup.style.background = '#fff';
      popup.style.fontFamily = "'Roboto', Arial, sans-serif";
      popup.style.padding = '22px 26px';
      popup.style.borderRadius = '12px';
      popup.style.boxShadow = '0 6px 20px rgba(0,0,0,0.25)';
      popup.style.maxWidth = '420px';
      popup.style.textAlign = 'left';
      popup.style.fontSize = '0.95rem';
      popup.style.lineHeight = '1.5em';
      popup.style.color = '#333';
      popup.innerHTML = `
        <h3 style="margin-top:0; color:#387b5b; font-size:1.1rem;">InformaciÃ³n descuento RGI / IMV</h3>
        <p style="margin-bottom:0.8em;">${infoText}</p>
        <div style="text-align:right; margin-top:12px;">
          <button id="closeRgiPopup" style="padding:6px 14px; border:none; border-radius:6px; background:#387b5b; color:white; cursor:pointer;">Cerrar</button>
        </div>
      `;

      overlay.appendChild(popup);
      document.body.appendChild(overlay);

      document.getElementById('closeRgiPopup').addEventListener('click', () => {
        overlay.remove();
      });
      overlay.addEventListener('click', e => {
        if (e.target === overlay) overlay.remove();
      });
    }
  });
}

</script>
<div id="popupOverlay" class="popupOverlay">
  <div class="popupBox">
    <span id="popupClose" class="popupClose">&times;</span>
    <h3 id="popupTitle">InformaciÃ³n</h3>
    <div id="popupContent"></div>
  </div>
</div>

</body>
</html>





















