<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Calculadora de Cuotas del Club</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Roboto', Arial, sans-serif;
  background: #ffffff;
  color: #111;
  padding: 20px;
}
.card {
  background: #ffffff;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
  width: 95%;
  max-width: 1000px;
  margin: 0 auto;
}
h1 {
  margin: 0 0 12px;
  color: #387b5b;
}
.row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 8px;
}
label {
  font-weight: 600;
  font-size: 0.95rem;
  margin-bottom: 4px;
  display: block;
}
select, .output {
  padding: 6px 8px;
  border-radius: 8px;
  border: 1px solid #d0d7e0;
  font-size: 0.95rem;
}
.member {
  border: 1px dashed #c0e3c3;
  padding: 8px;
  border-radius: 10px;
  margin-bottom: 6px;
  background: #e6f3ec;
  transition: background 0.3s;
}
.member h3 {
  margin: 0 0 6px;
  font-size: 1rem;
}
.member.free { background: #fff3e0; }
.results {
  margin-top: 10px;
  padding: 8px;
  border-radius: 8px;
  background: #e6f3ec;
  font-weight: 700;
  width: 100%;
  box-sizing: border-box;
}
.small {
  font-size: 0.9rem;
  color: #555;
}
.inline {
  display: flex;
  gap: 8px;
  align-items: center;
}
.total {
  margin-top: 10px;
  padding: 10px;
  border-radius: 8px;
  background: #e6f3ec;
  font-weight: 800;
  font-size: 1.05rem;
  width: 100%;
  box-sizing: border-box;
}
button {
  padding: 6px 12px;
  border-radius: 8px;
  border: 0;
  background: #387b5b;
  color: #fff;
  cursor: pointer;
}
button:disabled {
  background: #c0dfc8;
  cursor: not-allowed;
}
.member .altaCuota {
  margin-top: 4px;
  font-weight: 600;
  color: #387b5b;
  font-size: 0.85rem;
}
.member .plazosCuota {
  margin-top: 2px;
  color: #555;
  font-size: 0.85rem;
}
.total-claro {
  display: block;
  font-size: 0.9em;
  color: #333;
  background-color: #f0f7f0;
  border: 1px solid #c0e3c3;
  padding: 6px 10px;
  margin-top: 8px;
  border-radius: 6px;
  line-height: 1.4em;
  text-align: right;
  width: fit-content;
  margin-left: auto;
}
.total-claro span.small {
  font-size: 0.8em;
  color: #387b5b;
  text-decoration: underline;
  cursor: pointer;
}
.popupLink {
  color: #387b5b;
  text-decoration: underline;
  cursor: pointer;
}
.resumenLine {
  font-size: 0.85em;
  margin-bottom: 2px;
}
.popupOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.popupBox {
  background: #ffffff;
  border-radius: 12px;
  max-width: 420px;
  padding: 20px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  text-align: left;
  font-size: 0.95rem;
}
.popupBox h3 {
  margin-top: 0;
  font-size: 1.1rem;
  color: #387b5b;
}
.popupClose {
  float: right;
  font-weight: bold;
  cursor: pointer;
  color: #387b5b;
}
.popupClose:hover {
  color: #333;
}
#infoContext {
  margin-bottom: 16px;
  padding: 12px;
  background: #e6f3ec;
  border: 1px solid #c0e3c3;
  border-radius: 8px;
  font-size: 0.95rem;
  line-height: 1.4;
}
#infoContext p { margin: 4px 0; }
#infoContext p strong { color: #387b5b; }
</style>
</head>
<body>
<div class="card">
  <h1>Calculadora de cuotas del club</h1>
  <div id="infoContext">
    <p><strong>Cuota anual aprobada en Asamblea General del 22 de febrero de 2025</strong></p>
    <p>La CUOTA ANUAL se domicilia en 6 plazos, para hacer mÃ¡s asequible su pago.</p>
    <p><strong>âš ï¸ NO SON COBROS QUE CORRESPONDAN A MESES, DÃAS u HORAS DE ACTIVIDAD;</strong> SINO UNA APORTACIÃ“N ANUAL PARA EL SUSTENTO DEL CLUB PARA TODO EL AÃ‘O.</p>
    <p>âš ï¸ SegÃºn la categorÃ­a y la secciÃ³n, el plazo y la duraciÃ³n de entrenamiento suele variar.</p>
    <p>â„¹ï¸ A partir del 1 de octubre de 2025 (1 de noviembre para Master), las nuevas inscripciones tendrÃ¡n que abonar cuota de alta de 28â‚¬.</p>
    <p>Junto con la inscripciÃ³n, la persona inscrita o tutor legal se hace socio/a del club, con derecho a participar y votar. <a href="https://www.es.buruntzaldeaikt.eus/el-club/estatutos" target="_blank">Ver Estatutos</a></p>
  </div>

  <div class="row">
    <div style="width:250px">
      <label>
        <input type="checkbox" id="useRGI" name="rgiCheck" class="rgiCheck">
        Aplicar descuento RGI / IMV 
        <span class="small" title="Ayuda RGI / IMV, descuento del 75%. Si seleccionas este descuento, tendrÃ¡s que presentar justificante de haber cobrado la ayuda antes del 25 de cada mes.">(?)</span>
      </label>
    </div>
    <div style="width:200px">
      <label for="totalFam">Total familiares</label>
      <select id="totalFam">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4 o mÃ¡s</option>
      </select>
    </div>
    <div style="width:160px; align-self:flex-end">
      <button id="loadBtn">Pulsa para cargar datos y empezar</button>
    </div>
  </div>

  <div id="membersContainer"></div>

  <div id="summaryArea" style="display:none; width: 100%;">
    <div class="results"><strong>Resumen</strong><br></div>
    <div class="results" id="resultsBox"></div>
    <div class="total" id="totalBox">Total: â€”</div>
  </div>
</div>

<script>
// --------------------- CONFIGURACIÃ“N DE CSV ---------------------
const csvSheets = {
"2019 1 dÃ­a Lasarte-Oria":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=1104631462&single=true&output=csv",
"2019 2 dÃ­as Lasarte-Oria":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=594372538&single=true&output=csv",
"2018-2014 Lasarte-Oria":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=854262720&single=true&output=csv",
"2013-2012 Lasarte-Oria":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=174360607&single=true&output=csv",
"2011--> 18+ Lasarte-Oria":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=786890196&single=true&output=csv",
"2017--> 18+ Andoain":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=641105268&single=true&output=csv",
"Nat. ParticipaciÃ³n 1 dÃ­a":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=541455715&single=true&output=csv",
"Nat. ParticipaciÃ³n 2 dÃ­as":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=2101736621&single=true&output=csv",
"Master":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=2128438898&single=true&output=csv"
};

let sheets = {};
const loadBtn = document.getElementById('loadBtn');
const membersContainer = document.getElementById('membersContainer');
const totalFamSelect = document.getElementById('totalFam');
const summaryArea = document.getElementById('summaryArea');
const resultsBox = document.getElementById('resultsBox');
const totalBox = document.getElementById('totalBox');
const useRGIcheckbox = document.getElementById('useRGI');

// --------------------- CARGA DE CSV ---------------------
loadBtn.addEventListener('click', async()=>{
  loadBtn.disabled=true; loadBtn.textContent='Cargando...';
  membersContainer.innerHTML=''; summaryArea.style.display='none'; sheets={};
  try{
    await Promise.all(Object.entries(csvSheets).map(async([name,url])=>{
      const r = await fetch(url); if(!r.ok) throw new Error('Error al cargar '+name);
      const text = await r.text();
      sheets[name] = csvToObjects(text);
    }));
    createMemberBlocks();
    summaryArea.style.display='block';
    recalcAll();
  }catch(e){ alert('Error cargando CSV: '+e.message);}
  finally{loadBtn.disabled=false; loadBtn.textContent='Datos cargados';}
});

totalFamSelect.addEventListener('change',()=>{
  createMemberBlocks();
  recalcAll();
});
useRGIcheckbox.addEventListener('change', recalcAll);

// --------------------- CREACIÃ“N DE BLOQUES ---------------------
function createMemberBlocks(){
Â  membersContainer.innerHTML='';Â 
Â  const count=Number(totalFamSelect.value);
Â  for(let i=0;i<count;i++){
Â  Â  const div=document.createElement('div'); div.className='member';
Â  Â  // Usamos flexbox para que los tres divs internos compartan el espacio disponible
Â  Â  div.innerHTML=`<h3>Familiar ${i+1}</h3>
Â  Â  <div style="display: flex; gap: 5px; flex-wrap: wrap;">Â 
Â  Â  Â  <div style="flex: 1; min-width: 280px; align-self: flex-start;">Â 
Â  Â  Â  Â  <label>Selecciona Grupo</label>
Â  Â  Â  Â  <select class="sheetSelect"></select>
Â  Â  Â  </div>
Â  Â  Â  <div style="flex: 1; min-width: 200px; align-self: flex-start;">Â 
Â  Â  Â  Â  <label>Mes de inicio</label>
Â  Â  Â  Â  <select class="monthSelect"><option>â€”</option></select>
Â  Â  Â  </div>
Â  Â  Â <div style="flex: 1; min-width: 250px; align-self: flex-start;"> 
<label>Cuota aplicada</label>
Â  Â  Â  Â  <div style="display: flex; gap: 8px; align-items: center; justify-content: space-between; flex-wrap: wrap;"> 
Â  Â  Â  Â  Â  <div class="output feeDisplay" style="flex: 1;">â€”</div> 
Â  Â  Â  Â  Â  <div class="altaCuota" style="white-space: nowrap;"></div> 
Â  Â  Â  Â  Â  <div class="plazosCuota small" style="white-space: nowrap;"></div> 
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
    <div class="explicacionCuota"></div>`;
Â  Â  membersContainer.appendChild(div);
Â  Â  const sheetSel = div.querySelector('.sheetSelect');
Â  Â  Object.keys(csvSheets).forEach(name=>{
Â  Â  Â  const opt=document.createElement('option'); opt.value=name; opt.textContent=name; sheetSel.appendChild(opt);
Â  Â  });
Â  Â  sheetSel.addEventListener('change', ()=>{
Â  Â  Â  populateMonthsForMember(div);
Â  Â  Â  recalcAll();
Â  Â  });
Â  Â  div.querySelector('.monthSelect').addEventListener('change', recalcAll);
Â  }
Â  document.querySelectorAll('.member').forEach(m=>{
Â  Â  const s=m.querySelector('.sheetSelect');
Â  Â  if(s.options.length)s.selectedIndex=0;
Â  Â  populateMonthsForMember(m);
Â  });
}

// --------------------- POBLAR MESES ---------------------
function populateMonthsForMember(memberDiv){
  const sheetSel = memberDiv.querySelector('.sheetSelect');
  const monthSel = memberDiv.querySelector('.monthSelect');
  monthSel.innerHTML = '';
  const sheet = sheets[sheetSel.value];
  if(!sheet){ 
    monthSel.innerHTML='<option>â€”</option>'; 
    return;
  }
  const months = sheet.map(r => r['Mes inicio']).filter(Boolean);
  const seen = new Set();
  const uniq = months.filter(m => (seen.has(m)?false:seen.add(m)));
  if(uniq.length === 0){
      monthSel.innerHTML='<option>â€”</option>';
  } else {
      uniq.forEach(m=>{
          const o = document.createElement('option');
          o.value = m;
          o.textContent = m;
          monthSel.appendChild(o);
      });
      monthSel.selectedIndex = 0;
  }
}

// --------------------- PARSE CSV ---------------------
function csvToObjects(csv){
Â  const rows=[]; const lines=csv.split(/\r\n|\n/);Â 
Â  if(lines.length<9) return rows;
Â  const headers=parseCsvLine(lines[7]); // <-- Volvemos a usar la LÃ­nea 7
Â  for(let i=8;i<lines.length;i++){Â  // <-- Volvemos a empezar la lectura en la LÃ­nea 8
Â  Â  if(!lines[i].trim()) continue;
Â  Â  const vals=parseCsvLine(lines[i]);Â 
Â  Â  const obj={};
Â  Â  for(let j=0;j<headers.length;j++) obj[headers[j].trim()]=vals[j]?vals[j].trim():'';Â 
Â  Â  rows.push(obj);
Â  }Â 
Â  return rows;
}
function parseCsvLine(line){
  const result=[]; let inQuotes=false, val=''; 
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='\"') inQuotes=!inQuotes;
    else if(ch===',' && !inQuotes){ result.push(val); val=''; }
    else val+=ch;
  }
  result.push(val); return result;
}

// --------------------- CÃLCULO DE CUOTAS ---------------------
function recalcAll(){
  const members = document.querySelectorAll('.member');
  const countFam = Number(totalFamSelect.value);
  const useRGI = useRGIcheckbox.checked;
  const fees = [];

  members.forEach((m)=>{
    const sheetName = m.querySelector('.sheetSelect').value;
    const month = m.querySelector('.monthSelect').value;
    const sheet = sheets[sheetName];
    let fee = 0;
    let row = null;

    if(sheet && month && month !== 'â€”'){
      row = sheet.find(r => r['Mes inicio']?.trim() === month.trim());
     if(row){
Â  Â  Â  Â  // 1. Obtenemos la cuota base de '1 familiar' (o el encabezado de la cuota completa)
Â  Â  Â  Â  fee = parseFloat((row['1 familiar']||'0').replace(',','.').replace('â‚¬','')) || 0;
Â  Â  Â  Â  
Â  Â  Â  Â  // 2. Si se usa RGI, aplicamos el descuento del 75% (pagar el 25%)
Â  Â  Â  Â  if (useRGI && fee > 0) {
Â  Â  Â  Â  Â  fee = fee * 0.25; 
Â  Â  Â  Â  }
Â  Â  Â  }
    }

    fees.push({div:m, fee, row});
    m.classList.remove('free');
  });

  // Ajuste por nÃºmero de familiares si NO RGI
  if(!useRGI){
    if(countFam === 2){
      fees.forEach(f => {
        if(f.row) f.fee = parseFloat((f.row['2 familiares']||f.fee).replace(',','.').replace('â‚¬','')) || f.fee;
      });
    } else if(countFam === 3){
      const sorted = [...fees].sort((a,b)=>b.fee - a.fee);
      if(sorted[0] && sorted[0].row) sorted[0].fee = parseFloat((sorted[0].row['2 familiares']||sorted[0].fee).replace(',','.').replace('â‚¬','')) || sorted[0].fee;
      if(sorted[1] && sorted[1].row) sorted[1].fee = parseFloat((sorted[1].row['2 familiares']||sorted[1].fee).replace(',','.').replace('â‚¬','')) || sorted[1].fee;
      if(sorted[2] && sorted[2].row) sorted[2].fee = parseFloat((sorted[2].row['Tercer familiar']||sorted[2].fee).replace(',','.').replace('â‚¬','')) || sorted[2].fee;
    } else if(countFam >= 4){
      const sorted = [...fees].sort((a,b)=>b.fee - a.fee);
      if(sorted[0] && sorted[0].row) sorted[0].fee = parseFloat((sorted[0].row['2 familiares']||sorted[0].fee).replace(',','.').replace('â‚¬','')) || sorted[0].fee;
      if(sorted[1] && sorted[1].row) sorted[1].fee = parseFloat((sorted[1].row['2 familiares']||sorted[1].fee).replace(',','.').replace('â‚¬','')) || sorted[1].fee;
      if(sorted[2] && sorted[2].row) sorted[2].fee = parseFloat((sorted[2].row['Tercer familiar']||sorted[2].fee).replace(',','.').replace('â‚¬','')) || sorted[2].fee;
      for(let i=3;i<sorted.length;i++) sorted[i].fee = 0;
    }
  }

  // Cuota de alta
  fees.forEach(f=>{
    const monthSel = f.div.querySelector('.monthSelect');
    const altaDiv = f.div.querySelector('.altaCuota');
    const monthIndex = monthSel.selectedIndex;
    const alta = (monthIndex >= 1) ? 28 : 0;
    f.alta = alta;
    altaDiv.innerHTML = alta ? '<span style="color:#387b5b;">Cuota de Alta: 28 â‚¬ (Solamente una vez)</span>' : '';
  });

  // Mostrar cuota
  fees.forEach(f=>{
    const display = f.div.querySelector('.feeDisplay');
    display.textContent = f.fee > 0 ? f.fee.toFixed(2)+' â‚¬' : '0 â‚¬ (no paga)';
  });

 // Plazos
Â  fees.forEach(f=>{
Â  Â  const monthSel = f.div.querySelector('.monthSelect');
Â  Â  const sheetName = f.div.querySelector('.sheetSelect').value; // Necesitamos el grupo para saber si es Master
Â  Â  const monthIndex = monthSel.selectedIndex;
Â  Â  const isMaster = sheetName.includes('Master');
// ... (cÃ³digo anterior)

Â  Â  // Elemento donde mostraremos el texto condicional
Â  Â  const explainerDiv = f.div.querySelector('.explicacionCuota'); 
Â  Â  let explainerText = '';

Â  Â  // --------------------- LÃ³gica de ExplicaciÃ³n Condicional ---------------------
Â  Â  // Si el mes de inicio es el segundo o posterior (Ã­ndice 1 o mayor):
Â  Â  if (monthIndex >= 1) {
Â  Â  Â  // Definir los meses lÃ­mite para la explicaciÃ³n
Â  Â  Â  const ultimoPlazo = isMaster ? 'abril' : 'marzo';
Â  Â  Â  const inicioAlta = isMaster ? '1 de noviembre de 2025' : '1 de octubre de 2025';
Â  Â  Â  
Â  Â  Â  explainerText = `
Â  Â  Â  Â  <p style="font-size: 0.85rem; color: #1e8449; margin-top: 5px; padding: 5px; border-left: 3px solid #1e8449; background-color: #f0fff0;">
Â  Â  Â  Â  Â  *Ajuste de Cuota y Plazos:* Si alguien no comienza la temporada al principio, la cuota anual se adapta para que, junto con todos los demÃ¡s, el Ãºltimo plazo sea en marzo (abril para el grupo Master). Se tienen en cuenta los meses que no se han realizado.
Â  Â  Â  Â  Â  <br>
Â  Â  Â  Â  Â  **Cuota de Alta:** Quienes comienzan a partir del 1 de octubre (1 de noviembre para el grupo Master) tienen una cuota de alta de 28 â‚¬. Quienes se inscriben antes de esa fecha NO pagan cuota de alta.
Â  Â  Â  Â  </p>
Â  Â  Â  `;
Â  Â  }

Â  Â  explainerDiv.innerHTML = explainerText;
Â  Â  // --------------------- Fin LÃ³gica de ExplicaciÃ³n ---------------------

Â  // ... (el resto del cÃ³digo de plazos, fees.push, etc.)
Â  Â  let plazoText = '';
Â  Â  let infoPopupText = ''; // Variable para el contenido del popup

Â  Â  if(monthIndex === 0) {
Â  Â  Â  plazoText = '6 plazos domiciliados';
Â  Â  Â  infoPopupText = isMaster 
Â  Â  Â  Â  ? 'Del 1 al 5 de {Noviembre, Diciembre, Enero, Febrero, Marzo y Abril}'
Â  Â  Â  Â  : 'Del 1 al 5 de {Octubre, Noviembre, Diciembre, Enero, Febrero y Marzo}';
Â  Â  } else if(monthIndex === 1) {
Â  Â  Â  plazoText = '5 plazos domiciliados';
Â  Â  Â  infoPopupText = isMaster
Â  Â  Â  Â  ? 'Del 1 al 5 de {Diciembre, Enero, Febrero, Marzo y Abril}'
Â  Â  Â  Â  : 'Del 1 al 5 de {Noviembre, Diciembre, Enero, Febrero y Marzo}';
Â  Â  } else if(monthIndex === 2) {
Â  Â  Â  plazoText = '4 plazos domiciliados';
Â  Â  Â  infoPopupText = isMaster
Â  Â  Â  Â  ? 'Del 1 al 5 de {Enero, Febrero, Marzo y Abril}'
Â  Â  Â  Â  : 'Del 1 al 5 de {Diciembre, Enero, Febrero y Marzo}';
Â  Â  } else if(monthIndex === 3) {
Â  Â  Â  plazoText = '3 plazos domiciliados';
Â  Â  Â  infoPopupText = isMaster
Â  Â  Â  Â  ? 'Del 1 al 5 de {Febrero, Marzo y Abril}'
Â  Â  Â  Â  : 'Del 1 al 5 de {Enero, Febrero y Marzo}';
Â  Â  } else if(monthIndex === 4) {
Â  Â  Â  plazoText = '2 plazos domiciliados';
Â  Â  Â  infoPopupText = isMaster
Â  Â  Â  Â  ? 'Del 1 al 5 de {Marzo y Abril}'
Â  Â  Â  Â  : 'Del 1 al 5 de {Febrero y Marzo}';
Â  Â  } else if(monthIndex === 5) {
Â  Â  Â  plazoText = '1 plazo domiciliado';
Â  Â  Â  infoPopupText = isMaster
Â  Â  Â  Â  ? 'Del 1 al 5 de {Abril}'
Â  Â  Â  Â  : 'Del 1 al 5 de {Marzo}';
Â  Â  } else {
Â  Â  Â  plazoText = '1 pago por transferencia ABANCA ES75...'; // Usamos el texto de la cuota original
Â  Â  Â  infoPopupText = 'En el momento de la inscripciÃ³n. <br>Transferencia a la cuenta del club en ABANCA<br><b>ABANCA ES75 2080 3637 8130 4003 7051</b>';
Â  Â  Â  
Â  Â  Â  // Corregimos el texto de plazos para meses posteriores al sexto
Â  Â  Â  const mesesTransferencia = monthIndex - 5; 
Â  Â  Â  plazoText = `1 pago por transferencia `;
Â  Â  }
// --------------------- CALCULAR PLAZOS RESTANTES ---------------------
let plazos = 6 - monthIndex; // por defecto 6 plazos si es inicio octubre/noviembre
if(plazos < 1) plazos = 1;   // mÃ­nimo 1 pago
f.plazosRestantes = plazos;

Â  Â  
Â  Â  // Generamos el enlace al popup para mostrar los detalles del cobro
Â  Â  const infoLink = `<span class="popupLink" data-info="ğŸ“… <b>Fecha de pago:</b><br>${infoPopupText}"><small>[info]</small></span>`;

Â  Â  f.div.querySelector('.plazosCuota').innerHTML = `${plazoText} ${infoLink}`;
Â  });

// Total Anual
// Totales actualizados
const totalPrimerPago = fees.reduce((acc,f)=>acc + f.fee + f.alta, 0);
const totalAnual = fees.reduce((acc,f)=>acc + f.fee * f.plazosRestantes + f.alta, 0);
const totalPagosPosteriores = totalAnual - totalPrimerPago;

// Generamos el detalle del primer pago
const primerPagoDetail = (fees.some(f => f.alta > 0)) 
  ? `(Cuota club + Cuota de Alta)` 
  : `(Cuota club)`;

// Mostrar en caja
totalBox.innerHTML = `
<div style="background:#fff; border-radius:10px; padding:10px 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); font-weight:700; margin-bottom:8px;">
  Total Anual: ${totalAnual.toFixed(2)} â‚¬ (Incluye todas las cuotas de alta y meses restantes)
</div>

<div style="display: flex; gap: 20px; border-top: 1px solid #c0d0c0; padding-top: 4px; flex-wrap: wrap;">
  <div>
    <strong>Primer Pago:</strong> ${totalPrimerPago.toFixed(2)} â‚¬
    <div class="small" style="font-weight: normal;">${primerPagoDetail}</div>
  </div>
  <div>
    <strong>Pagos Posteriores:</strong> ${totalPagosPosteriores.toFixed(2)} â‚¬
    <div class="small" style="font-weight: normal;">(Suma de los plazos restantes sin cuota de alta)</div>
  </div>
</div>
`;




 // --------------------- RESUMEN ---------------------
resultsBox.innerHTML = ''; // limpiar contenido previo
fees.forEach((f, idx) => {
  const sheetName = f.div.querySelector('.sheetSelect').value;
  const month = f.div.querySelector('.monthSelect').value;

  let cuotaText = f.fee > 0 ? f.fee.toFixed(2)+' â‚¬' : '0 â‚¬ (no paga)';
  let altaText = f.alta ? ' + Cuota de Alta: 28 â‚¬ (Solamente una vez)' : '';

  let monthIndex = f.div.querySelector('.monthSelect').selectedIndex;
  let plazos = 1;
  let formaPago = '';

  if (monthIndex >= 0 && monthIndex <= 5) {
    plazos = 6 - monthIndex;
    formaPago = `<span class="popupLink" data-info='ğŸ¦â†ªï¸ <b>Cobro domiciliado:</b><br>Se realiza mediante domiciliaciÃ³n bancaria mensual.<br>El Ãºltimo plazo es del <b>1 al 5 de marzo</b> a excepciÃ³n del grupo "<b>Masters</b>", cuyo Ãºltimo plazo es del <b>1 al 5 de abril</b><br><br><br>
<b>Plazos de domiciliaciÃ³n:</b><br>
Durante la temporada 2025/2026, los plazos quedarÃ¡n de la siguiente manera:<br>
1Âª domiciliaciÃ³n: del 1 al 5 de octubre. <b>(Masters NO)</b><br>
2Âª domiciliaciÃ³n: del 1 al 5 de noviembre.(1Âª Masters)<br>
3Âª domiciliaciÃ³n: del 1 al 5 de diciembre.(2Âª Masters)<br>
4Âª domiciliaciÃ³n: del 1 al 5 de enero.(3Âª Masters)<br>
5Âª domiciliaciÃ³n: del 1 al 5 de febrero.(4Âª Masters)<br>
6Âª domiciliaciÃ³n: del 1 al 5 de marzo.(5Âª Masters)<br>
7Âª domiciliaciÃ³n: del 1 al 5 de marzo.(<b>SOLO Masters, 6Âª</b>).'>Cobro domiciliado</span>`;
  } else {
    formaPago = `<span class="popupLink" data-info='ğŸ¦â¡ï¸ <b>Transferencia bancaria:</b><br>La persona que se inscribe realiza un Ãºnico pago a la cuenta ABANCA proporcionada:<br><b>ABANCA ES75 2080 3637 8130 4003 7051</b>.'>Transferencia bancaria ABANCA ES75 2080 3637 8130 4003 7051</span>`;
  }

  const div = document.createElement('div');
  div.className = 'resumenLine';
  div.innerHTML = `Familiar ${idx+1}: ${sheetName} | ${month} | ${cuotaText}${altaText} | Plazos: ${plazos} (${formaPago})`;
  resultsBox.appendChild(div);
});

// --------------------- POPUPS MODERNOS ---------------------
document.querySelectorAll('.popupLink').forEach(el=>{
  el.addEventListener('click', e=>{
    e.preventDefault();

    const infoText = el.dataset.info;
    // Crear fondo oscuro
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.zIndex = '9999';
    overlay.style.padding = '10px';

    // Crear ventana del popup
    const popup = document.createElement('div');
    popup.style.background = '#fff';
    popup.style.fontFamily = "'Roboto', Arial, sans-serif";
    popup.style.padding = '22px 26px';
    popup.style.borderRadius = '12px';
    popup.style.boxShadow = '0 6px 20px rgba(0,0,0,0.25)';
    popup.style.maxWidth = '420px';
    popup.style.textAlign = 'left';
    popup.style.fontSize = '0.95rem';
    popup.style.lineHeight = '1.5em';
    popup.style.color = '#333';
    popup.innerHTML = `
      <h3 style="margin-top:0; color:#387b5b; font-size:1.1rem;">InformaciÃ³n</h3>
      <p style="margin-bottom:0.8em;">${infoText}</p>
      <div style="text-align:right; margin-top:12px;">
        <button id="closePopup" style="padding:6px 14px; border:none; border-radius:6px; background:#387b5b; color:white; cursor:pointer;">Cerrar</button>
      </div>
    `;

    overlay.appendChild(popup);
    document.body.appendChild(overlay);

    document.getElementById('closePopup').addEventListener('click', ()=>{
      overlay.remove();
    });
    overlay.addEventListener('click', e=>{
      if(e.target === overlay) overlay.remove();
    });
  });
});
// --------------------- POPUP RGI / IMV AL MARCAR CHECKBOX ---------------------
const rgiCheckbox = document.getElementById('rgiCheck');
if (rgiCheckbox) {
  rgiCheckbox.addEventListener('change', () => {
    if (rgiCheckbox.checked) {
      const infoText = `
      ğŸ’¶ <b>Ayuda RGI / IMV</b><br><br>
      Descuento del <b>75%</b> en la cuota.<br>
      Si seleccionas este descuento, deberÃ¡s presentar justificante de haber cobrado la ayuda <b>antes del dÃ­a 25 de cada mes</b><br>Al seleccionar Ayuda RGI / IMV, descuento del 75% no se aplican los descuentos por familiares.
      `;

      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '9999';
      overlay.style.padding = '10px';

      const popup = document.createElement('div');
      popup.style.background = '#fff';
      popup.style.fontFamily = "'Roboto', Arial, sans-serif";
      popup.style.padding = '22px 26px';
      popup.style.borderRadius = '12px';
      popup.style.boxShadow = '0 6px 20px rgba(0,0,0,0.25)';
      popup.style.maxWidth = '420px';
      popup.style.textAlign = 'left';
      popup.style.fontSize = '0.95rem';
      popup.style.lineHeight = '1.5em';
      popup.style.color = '#333';
      popup.innerHTML = `
        <h3 style="margin-top:0; color:#387b5b; font-size:1.1rem;">InformaciÃ³n descuento RGI / IMV</h3>
        <p style="margin-bottom:0.8em;">${infoText}</p>
        <div style="text-align:right; margin-top:12px;">
          <button id="closePopup" style="padding:6px 14px; border:none; border-radius:6px; background:#387b5b; color:white; cursor:pointer;">Cerrar</button>
        </div>
      `;

      overlay.appendChild(popup);
      document.body.appendChild(overlay);

      document.getElementById('closeRgiPopup').addEventListener('click', () => {
        overlay.remove();
      });
      overlay.addEventListener('click', e => {
        if (e.target === overlay) overlay.remove();
      });
    }
  });
}
}
// --------------------- POPUP RGI / IMV AL MARCAR CHECKBOX ---------------------
const rgiCheckbox = document.querySelector('#useRGI');
if (rgiCheckbox) {
  rgiCheckbox.addEventListener('change', () => {
    if (rgiCheckbox.checked) {
      const infoText = `
      â„¹ï¸ <b>Ayuda RGI / IMV</b><br><br>
      Descuento del <b>75%</b> en la cuota.<br>
      Si seleccionas este descuento, deberÃ¡s presentar justificante de haber cobrado la ayuda <b>antes del dÃ­a 25 de cada mes</b><br><br>Al seleccionar Ayuda RGI / IMV, descuento del 75% no se aplican los descuentos por familiares.
      `;

      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '9999';
      overlay.style.padding = '10px';

      const popup = document.createElement('div');
      popup.style.background = '#fff';
      popup.style.fontFamily = "'Roboto', Arial, sans-serif";
      popup.style.padding = '22px 26px';
      popup.style.borderRadius = '12px';
      popup.style.boxShadow = '0 6px 20px rgba(0,0,0,0.25)';
      popup.style.maxWidth = '420px';
      popup.style.textAlign = 'left';
      popup.style.fontSize = '0.95rem';
      popup.style.lineHeight = '1.5em';
      popup.style.color = '#333';
      popup.innerHTML = `
        <h3 style="margin-top:0; color:#387b5b; font-size:1.1rem;">InformaciÃ³n descuento RGI / IMV</h3>
        <p style="margin-bottom:0.8em;">${infoText}</p>
        <div style="text-align:right; margin-top:12px;">
          <button id="closeRgiPopup" style="padding:6px 14px; border:none; border-radius:6px; background:#387b5b; color:white; cursor:pointer;">Cerrar</button>
        </div>
      `;

      overlay.appendChild(popup);
      document.body.appendChild(overlay);

      document.getElementById('closeRgiPopup').addEventListener('click', () => {
        overlay.remove();
      });
      overlay.addEventListener('click', e => {
        if (e.target === overlay) overlay.remove();
      });
    }
  });
}

</script>
<div id="popupOverlay" class="popupOverlay">
  <div class="popupBox">
    <span id="popupClose" class="popupClose">&times;</span>
    <h3 id="popupTitle">InformaciÃ³n</h3>
    <div id="popupContent"></div>
  </div>
</div>

</body>
</html>





















